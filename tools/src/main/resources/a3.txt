
## 片段化开发功能已上线～ 使用文档链接: https://km.sankuai.com/page/1271824941
## 可将长SQL拆分为多个可独立执行的片段（如一个子查询），单独修改调试，提升开发维护效率～
## 片段间可使用“$”进行引用，例如：
## SELECT  c.a  FROM $cut_n c
## 点击右上角复制按钮，我们会帮您将引用的CUT转为对应代码复制。键盘快捷键复制无法达成此效果，请自行选择。
## 祝您使用愉快～
 WITH ars_sale_forecast_theory_oss AS (
        SELECT dt,
               poi_id,
               base_sku_id,
               category3_id,
               category4_id,
               theory_sale AS theory_sale
          FROM mart_mallpa.topic_sc_ars_sale_forecast_poi_sku_theory_sale_dt
         WHERE dt = '20250907'

        UNION ALL

   	    SELECT dt,
               poi_id,
               base_sku_id,
               category3_id,
               category4_id,
               CAST(sale_complete AS DECIMAL(26,2)) AS theory_sale
          FROM mart_mallpa.topic_sc_ars_forecast_not_purchase_poi_sku_oos_fill_data_dt
         WHERE dt = '20250907'
       ),
       ars_sale_theory as(
        SELECT dt,
               poi_id,
               base_sku_id,
               category3_id,
               category4_id,
               sum(theory_sale) AS theory_sale_sum
          FROM ars_sale_forecast_theory_oss
          GROUP BY dt,
                  poi_id,
                  base_sku_id,
                  category3_id,
                  category4_id
       ),
       dim_poi_snapshot AS (
        SELECT dt,
               poi_id,
               management_city_id
          FROM mart_mall.dim_poi_snapshot
         WHERE dt = '20250907'
       ),
       fdc_deliver_group AS (
        SELECT dt,
               base_sku_id,
               poi_id,

 			   CASE flag
                    WHEN 88 THEN 1
                    WHEN 77 THEN 2
                    ELSE 3
                END AS business_group_type
          FROM mart_mall.topic_pdt_fdc_deliver_group_poi_sku_dt
         WHERE dt = '20250907'
         AND flag in (77,88)
       ),
       bom_multi_recipe AS (
        SELECT dt,
               poi_id,
               -- 加工品
               base_sku_id,
               -- 原料
 	           sku_base_id,
               management_city_id,
               -- 标准库存转化比例
 	           standard_quantity
          FROM mart_mall.dim_scp_sce_multi_recipe_ingredient_poi_sku_dt
         WHERE dt = '20250907'
       ),
       management_city_poi_sku_business_sale AS (
        SELECT a.dt AS dt,
               b.management_city_id AS management_city_id,
               a.poi_id AS poi_id,
               c.business_group_type as business_group_type,
               -- 加工品
               a.base_sku_id AS base_sku_id,
               a.category3_id AS category3_id,
               a.category4_id AS category4_id,
               -- 原料
               -- 加工品，此处是真正对应的原料
               -- 成品，此处还是成品本身
 	           NVL(d.sku_base_id, a.base_sku_id) AS sku_base_id,
               a.theory_sale_sum AS theory_sale_sum,
               d.standard_quantity AS standard_quantity,
               a.theory_sale_sum * IF(d.standard_quantity IS NULL OR d.standard_quantity = 0, CAST(1 AS DECIMAL(26,6)), d.standard_quantity) AS theory_sale_sum_split
          FROM ars_sale_theory a
          LEFT JOIN dim_poi_snapshot b ON (a.dt = b.dt AND a.poi_id = b.poi_id)
          LEFT JOIN fdc_deliver_group c ON (a.dt = c.dt AND a.poi_id = c.poi_id AND a.base_sku_id = c.base_sku_id)
          LEFT JOIN bom_multi_recipe d ON (a.dt = d.dt AND a.poi_id = d.poi_id AND a.base_sku_id = d.base_sku_id)
       )
       SELECT *
       FROM management_city_poi_sku_business_sale;